<h1 class="mt-3">Custom metrics</h1>

<nb-alert
  *ngIf="configurations?.length === 0"
  class="alert-config flex-row align-items-center"
  accent="warning"
>
  <nb-icon
    class="mr-1"
    icon="alert-triangle-outline"
    status="warning"
  ></nb-icon>
  No bot configuration detected
</nb-alert>

<nb-card
  [nbSpinner]="loading"
  *ngIf="configurations?.length > 0"
>
  <nb-card-header class="d-flex gap-1">
    <nb-form-field>
      <nb-icon
        nbPrefix
        icon="calendar-outline"
      ></nb-icon>
      <input
        #dateRangeInput
        nbInput
        fieldSize="medium"
        placeholder="Pick date range"
        [nbDatepicker]="dateRangePicker"
        [(ngModel)]="range"
      />
    </nb-form-field>

    <div>
      <button
        nbButton
        ghost
        status="info"
        nbTooltip="Display metrics for the last 3 days"
        (click)="setTimeRange(timeRanges.day)"
      >
        3d
      </button>
      <button
        nbButton
        ghost
        status="info"
        nbTooltip="Display metrics for the last 7 days"
        (click)="setTimeRange(timeRanges.week)"
      >
        7d
      </button>
      <button
        nbButton
        ghost
        status="info"
        nbTooltip="Display metrics for the last month"
        (click)="setTimeRange(timeRanges.month)"
      >
        1m
      </button>
      <button
        nbButton
        ghost
        status="info"
        nbTooltip="Display metrics for the last 3 months"
        (click)="setTimeRange(timeRanges.quarter)"
      >
        3m
      </button>
    </div>
  </nb-card-header>

  <nb-rangepicker
    #dateRangePicker
    [(range)]="range"
    (rangeChange)="datePickerChange($event)"
  ></nb-rangepicker>

  <nb-card-body class="main-card-body">
    <div class="row mt-3">
      <div class="col-12 mb-3">
        <div class="stats-line p-2">
          Number of user messages
          <span class="stats-line-value">{{ userMessagesSum }}</span>
        </div>
        <div class="stats-line p-2">
          Number of answers
          <span class="stats-line-value">{{ answeredMessages }}</span>
        </div>
        <div class="stats-line p-2">
          Number of unanswered messages
          <span class="stats-line-value">{{ unAnsweredMessages }}</span>
        </div>
        <div class="stats-line p-2 font-weight-bold">
          Bot response rate
          <span class="stats-line-value">{{ responseRate }}%</span>
        </div>
      </div>
    </div>

    <div class="row mt-3">
      <div class="col-12 col-md-6">
        <h6>Number of user messages</h6>
        <div
          *ngIf="messagesChartOptions"
          echarts
          [options]="messagesChartOptions"
        ></div>
      </div>

      <div class="col-12 col-md-6">
        <div class="row mb-3">
          <div class="col-6">
            <h6>Distribution of stories</h6>
          </div>
          <div
            class="col-6 text-right"
            *ngIf="indicatorsDimensions.length"
          >
            <nb-select
              *ngIf="indicators"
              nbTooltip="Filter stories by type and category"
              placeholder="Filters"
              size="small"
              class="full-width"
              multiple
              [(ngModel)]="selectedStoriesFilters"
              (selectedChange)="storiesFilterSelected()"
              [compareWith]="matchStoriesFilters"
            >
              <nb-option [value]="{ type: storiesFilterType.metricsStories }">Show metrics stories</nb-option>
              <nb-option-group title="Stories types">
                <ng-container *ngFor="let filter of storiesFilters">
                  <nb-option
                    *ngIf="filter.type === storiesFilterType.currentType"
                    [value]="filter"
                    >{{ filter.value }}</nb-option
                  >
                </ng-container>
              </nb-option-group>

              <nb-option-group title="Stories categories">
                <ng-container *ngFor="let filter of storiesFilters">
                  <nb-option
                    *ngIf="filter.type === storiesFilterType.category"
                    [value]="filter"
                    >{{ filter.value }}</nb-option
                  >
                </ng-container>
              </nb-option-group>
            </nb-select>
          </div>
        </div>

        <div
          echarts
          [options]="storiesChart"
        ></div>
      </div>
    </div>

    <div class="row mt-3">
      <div class="col-12">
        <div class="row mb-3">
          <div class="col-6">
            <h6>Indicators</h6>
          </div>
          <div
            class="col-6 text-right"
            *ngIf="indicatorsDimensions.length"
          >
            <nb-select
              *ngIf="indicators"
              nbTooltip="Select a dimension to display"
              placeholder="Select a dimension"
              size="small"
              (selectedChange)="dimensionSelected($event)"
              [(ngModel)]="currentDimension"
            >
              <nb-option
                *ngFor="let dimension of indicatorsDimensions"
                [value]="dimension"
                >{{ dimension }}</nb-option
              >
            </nb-select>
          </div>
        </div>

        <div
          *ngIf="!indicatorsDimensions.length"
          class="text-muted font-italic"
        >
          No indicator defined
        </div>

        <div class="row">
          <div
            class="col-12 col-md-6"
            *ngFor="let chart of currentDimensionCharts"
          >
            <div class="dimension-chart">
              <div class="row">
                <div class="col-8 initial-capitalize">
                  <strong>{{ chart.name }}</strong>
                </div>
                <div class="col-4 text-right">
                  <button
                    nbButton
                    ghost
                    size="tiny"
                    nbTooltip="Display indicator metrics for each story"
                    (click)="loadIndicatorMetrics(chart.indicatorName)"
                  >
                    Detail by stories
                  </button>
                </div>
              </div>

              <div
                echarts
                [options]="chart"
              ></div>
            </div>
          </div>
        </div>
      </div>
    </div>
  </nb-card-body>
</nb-card>
