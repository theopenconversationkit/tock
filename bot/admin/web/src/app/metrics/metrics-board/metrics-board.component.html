<!--
  ~ Copyright (C) 2017/2025 SNCF Connect & Tech
  ~
  ~ Licensed under the Apache License, Version 2.0 (the "License");
  ~ you may not use this file except in compliance with the License.
  ~ You may obtain a copy of the License at
  ~
  ~ http://www.apache.org/licenses/LICENSE-2.0
  ~
  ~ Unless required by applicable law or agreed to in writing, software
  ~ distributed under the License is distributed on an "AS IS" BASIS,
  ~ WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
  ~ See the License for the specific language governing permissions and
  ~ limitations under the License.
  -->

<h1>Custom metrics</h1>

<tock-no-data-found
  *ngIf="configurations?.length === 0"
  title="No bot configuration detected"
></tock-no-data-found>

<nb-card
  [nbSpinner]="loading"
  *ngIf="configurations?.length > 0"
>
  <nb-card-header class="d-flex gap-1">
    <div class="row">
      <div class="col-12 col-xl-6">
        <nb-form-field class="mb-2">
          <nb-icon
            nbPrefix
            icon="calendar-plus"
          ></nb-icon>
          <input
            nbInput
            fullWidth
            placeholder="From date"
            nbTooltip="Show data collected after this date"
            [nbDatepicker]="from_date"
            [(ngModel)]="range().start"
            (ngModelChange)="updateStart($event)"
          />
        </nb-form-field>

        <nb-date-timepicker
          #from_date
          [max]="max"
          [showCurrentTimeButton]="false"
          [step]="10"
          singleColumn
          format="y/MM/dd HH:mm"
        ></nb-date-timepicker>
      </div>

      <div class="col-12 col-xl-6">
        <nb-form-field class="mb-2">
          <nb-icon
            nbPrefix
            icon="calendar-minus"
          ></nb-icon>
          <input
            nbInput
            fullWidth
            placeholder="To date"
            nbTooltip="Show data collected before this date"
            [nbDatepicker]="to_date"
            [(ngModel)]="range().end"
            (ngModelChange)="updateEnd($event)"
          />
        </nb-form-field>

        <nb-date-timepicker
          #to_date
          [min]="min"
          [showCurrentTimeButton]="false"
          [step]="10"
          singleColumn
          format="y/MM/dd HH:mm"
        ></nb-date-timepicker>
      </div>
    </div>

    <div class="d-flex flex-wrap align-items-start">
      <button
        nbButton
        ghost
        status="info"
        nbTooltip="Display metrics for the last 3 days"
        (click)="setTimeRange(timeRanges.day)"
      >
        3d
      </button>
      <button
        nbButton
        ghost
        status="info"
        nbTooltip="Display metrics for the last 7 days"
        (click)="setTimeRange(timeRanges.week)"
      >
        7d
      </button>
      <button
        nbButton
        ghost
        status="info"
        nbTooltip="Display metrics for the last month"
        (click)="setTimeRange(timeRanges.month)"
      >
        1m
      </button>
      <button
        nbButton
        ghost
        status="info"
        nbTooltip="Display metrics for the last 3 months"
        (click)="setTimeRange(timeRanges.quarter)"
      >
        3m
      </button>
      <button
        nbButton
        ghost
        status="info"
        nbTooltip="Display metrics for the last 6 months"
        (click)="setTimeRange(timeRanges.halfYear)"
      >
        6m
      </button>
      <button
        nbButton
        ghost
        status="info"
        nbTooltip="Display metrics for the last year"
        (click)="setTimeRange(timeRanges.year)"
      >
        1y
      </button>
    </div>
  </nb-card-header>

  <nb-card-body class="main-card-body">
    <div class="row mt-0">
      <div class="col-12 mb-3">
        <div class="stats-line d-flex justify-content-between gap-1 py-2">
          <strong>&nbsp;</strong>
          <div class="d-flex">
            <span class="stats-value">End-user</span>
            <span class="stats-value test">Tests</span>
          </div>
        </div>

        <h6 class="mt-3 mb-2">Bot (Global) Activity</h6>

        <div class="stats-line d-flex justify-content-between gap-1 py-2">
          Total user messages
          <div class="d-flex">
            <span class="stats-value"
              ><strong>{{ dialogStats?.prod?.allUserActions || 0 }}</strong></span
            >
            <span class="stats-value test"
              ><strong>{{ dialogStats?.test?.allUserActions || 0 }}</strong></span
            >
          </div>
        </div>

        <div class="stats-line d-flex justify-content-between gap-1 py-2">
          Unknown user messages
          <div class="d-flex">
            <span class="stats-value"
              ><strong>{{ dialogStats?.prod?.unknownIntentUserActions || 0 }}</strong></span
            >
            <span class="stats-value test"
              ><strong>{{ dialogStats?.test?.unknownIntentUserActions || 0 }}</strong></span
            >
          </div>
        </div>

        <div class="stats-line d-flex justify-content-between gap-1 py-2">
          <div>
            Positive feedback
            <nb-icon
              icon="hand-thumbs-up-fill"
              class="text-success font-size-small mt-2"
            ></nb-icon>
          </div>
          <div class="d-flex">
            <span class="stats-value">{{ dialogStats?.prod?.allFeedbackUp || 0 }}</span>
            <span class="stats-value test">{{ dialogStats?.test?.allFeedbackUp || 0 }}</span>
          </div>
        </div>

        <div class="stats-line d-flex justify-content-between gap-1 py-2">
          <div>
            Negative feedback
            <nb-icon
              icon="hand-thumbs-down-fill"
              class="text-danger font-size-small mt-2"
            ></nb-icon>
          </div>
          <div class="d-flex">
            <span class="stats-value">{{ dialogStats?.prod?.allFeedbackDown || 0 }}</span>
            <span class="stats-value test">{{ dialogStats?.test?.allFeedbackDown || 0 }}</span>
          </div>
        </div>

        <h6 class="mt-3 mb-2">Bot (NLP) Statistics</h6>

        <div class="stats-line d-flex justify-content-between gap-1 py-2">
          Total NLP messages
          <div class="d-flex">
            <span class="stats-value"
              ><strong>{{ dialogStats?.prod?.allUserActionsExceptRag || 0 }}</strong></span
            >
            <span class="stats-value test"
              ><strong>{{ dialogStats?.test?.allUserActionsExceptRag || 0 }}</strong></span
            >
          </div>
        </div>

        <div class="stats-line d-flex justify-content-between gap-1 py-2">
          User messages with known Intent
          <div class="d-flex">
            <span class="stats-value">{{ dialogStats?.prod?.knownIntentUserActions || 0 }}</span>
            <span class="stats-value test">{{ dialogStats?.test?.knownIntentUserActions || 0 }}</span>
          </div>
        </div>

        <div class="stats-line d-flex justify-content-between gap-1 py-2">
          User messages classified as Unknown
          <div class="d-flex">
            <span class="stats-value">{{ dialogStats?.prod?.unknownIntentUserActionsExceptRag || 0 }}</span>
            <span class="stats-value test">{{ dialogStats?.test?.unknownIntentUserActionsExceptRag || 0 }}</span>
          </div>
        </div>

        <h6 class="mt-3 mb-2">Gen AI (RAG) Statistics</h6>

        <div class="stats-line d-flex justify-content-between gap-1 py-2">
          Total user messages sent to RAG
          <div class="d-flex">
            <span class="stats-value"
              ><strong>{{ dialogStats?.prod?.allUserRagActions || 0 }}</strong></span
            >
            <span class="stats-value test"
              ><strong>{{ dialogStats?.test?.allUserRagActions || 0 }}</strong></span
            >
          </div>
        </div>

        <div class="stats-line d-flex justify-content-between gap-1 py-2">
          Success RAG Responses
          <div class="d-flex">
            <span class="stats-value">{{ ragStats?.prod?.success || 0 }}</span>
            <span class="stats-value test">{{ ragStats?.test?.success || 0 }}</span>
          </div>
        </div>

        <div class="stats-line d-flex justify-content-between gap-1 py-2">
          No Answer RAG Responses
          <div class="d-flex">
            <span class="stats-value">{{ ragStats?.prod?.noAnswer || 0 }}</span>
            <span class="stats-value test">{{ ragStats?.test?.noAnswer || 0 }}</span>
          </div>
        </div>

        <div class="stats-line d-flex justify-content-between gap-1 py-2">
          Failed RAG Responses
          <div class="d-flex">
            <span class="stats-value">{{ ragStats?.prod?.failure || 0 }}</span>
            <span class="stats-value test">{{ ragStats?.test?.failure || 0 }}</span>
          </div>
        </div>
      </div>
    </div>

    <div class="row mt-3">
      <div
        class="col-12 col-xl-6"
        [ngClass]="{ 'force-col-12': doesStoriesHitsEcxeed(24) }"
      >
        <h6>Number of user messages</h6>
        <div
          *ngIf="messagesChartOptions"
          echarts
          [options]="messagesChartOptions"
          class="messages-height"
          [ngClass]="{ 'height-250': doesStoriesHitsEcxeed(24) }"
        ></div>
      </div>

      <div
        class="col-12 col-xl-6"
        [ngClass]="{ 'force-col-12': doesStoriesHitsEcxeed(24) }"
      >
        <div class="row mb-3">
          <div class="col-6">
            <h6>Distribution of stories</h6>
          </div>
          <div
            class="col-6 text-right"
            *ngIf="indicatorsDimensions.length"
          >
            <nb-select
              *ngIf="indicators"
              nbTooltip="Filter stories by type and category"
              placeholder="Filters"
              size="small"
              class="full-width"
              multiple
              [(ngModel)]="selectedStoriesFilters"
              (selectedChange)="storiesFilterSelected()"
              [compareWith]="matchStoriesFilters"
            >
              <nb-option [value]="{ type: storiesFilterType.metricsStories }">Show metrics stories</nb-option>
              <nb-option-group title="Stories types">
                <ng-container *ngFor="let filter of storiesFilters">
                  <nb-option
                    *ngIf="filter.type === storiesFilterType.currentType"
                    [value]="filter"
                    >{{ filter.value }}</nb-option
                  >
                </ng-container>
              </nb-option-group>

              <nb-option-group title="Stories categories">
                <ng-container *ngFor="let filter of storiesFilters">
                  <nb-option
                    *ngIf="filter.type === storiesFilterType.category"
                    [value]="filter"
                    >{{ filter.value }}</nb-option
                  >
                </ng-container>
              </nb-option-group>
            </nb-select>
          </div>
        </div>

        <div
          echarts
          [options]="storiesChart"
          (chartClick)="onStoriesChartClick($event)"
        ></div>
      </div>
    </div>

    <div class="row mt-3">
      <div class="col-12">
        <div class="row mb-3">
          <div class="col-6">
            <h6>Indicators</h6>
          </div>
          <div
            class="col-6 text-right"
            *ngIf="indicatorsDimensions.length"
          >
            <nb-form-field
              *ngIf="indicators"
              class="d-inline-flex"
            >
              <nb-icon
                nbPrefix
                icon="sign-merge-left"
              ></nb-icon>
              <nb-select
                nbTooltip="Select an indicators dimension to display"
                placeholder="Select a dimension"
                size="small"
                (selectedChange)="dimensionSelected($event)"
                [(ngModel)]="currentDimension"
              >
                <nb-option
                  *ngFor="let dimension of indicatorsDimensions"
                  [value]="dimension"
                  >{{ dimension }}</nb-option
                >
              </nb-select>
            </nb-form-field>
          </div>
        </div>

        <div
          *ngIf="!indicatorsDimensions.length"
          class="text-muted font-italic"
        >
          No indicator defined
        </div>

        <div class="row">
          <div
            class="col-12 col-md-6"
            *ngFor="let chart of currentDimensionCharts"
          >
            <div class="dimension-chart">
              <div class="row">
                <div class="col-8 initial-capitalize">
                  <strong>{{ chart.name }}</strong>
                </div>
                <div class="col-4 text-right">
                  <button
                    *ngIf="chart.indicatorName !== 'rag'"
                    nbButton
                    ghost
                    size="tiny"
                    nbTooltip="Display indicator metrics for each story"
                    (click)="loadIndicatorMetrics($any(chart).indicatorName)"
                  >
                    Detail by stories
                  </button>
                </div>
              </div>

              <div
                echarts
                [options]="chart"
              ></div>
            </div>
          </div>
        </div>
      </div>
    </div>
  </nb-card-body>
</nb-card>

<ng-template #unknownStoryHelpModal>
  <nb-card class="help-modal">
    <nb-card-header class="d-flex justify-content-between align-items-start gap-1">
      How to create an Unknown Story
      <button
        nbButton
        ghost
        shape="round"
        nbTooltip="Cancel"
        (click)="closeHelpModal()"
      >
        <nb-icon icon="x-lg"></nb-icon>
      </button>
    </nb-card-header>
    <nb-card-body>
      In order to obtain reliable statistics, it is necessary to create an "Unknown story". The "Unknown story" allows to determine the
      response of the bot when it does not understand the user request. Moreover, being a story, it allows to internationalize this answer.
      <br />
      <br />
      To create an "Unknown story" in your bot:
      <br />
      <br />
      <ol>
        <li>Go to "Stories & Answers" then "New story" tab.</li>
        <li>Give a name to your "Unknown story" (for example: Unknown Story) then validate</li>
        <li>Click on the "Edit story" icon and in the "Intent" field, enter the word "unknown"</li>
        <li>In the "Answers" part, enter the message to return to users when the bot does not understand their request.</li>
        <li>Click on "Create story"</li>
      </ol>
    </nb-card-body>
    <nb-card-footer class="card-footer-actions">
      <button
        nbButton
        ghost
        size="small"
        (click)="closeHelpModal()"
      >
        Close
      </button>
    </nb-card-footer>
  </nb-card>
</ng-template>

<tock-scroll-top-button></tock-scroll-top-button>
